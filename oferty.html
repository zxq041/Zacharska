<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wszystkie oferty - Centrum nieruchomości</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .scrollbar-none::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------- UTIL ----------
    const cn = (...classes) => classes.filter(Boolean).join(' ');
    const clamp = (n, min, max) => Math.max(min, Math.min(n, max));
    const currency = (n) => new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN", maximumFractionDigits: 0 }).format(n);
    const useLocalStorage = (key, initial) => {
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial } catch { return initial }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)) } catch {} }, [key, state]);
      return [state, setState];
    };

    // ---------- API ----------
    const api = {
      async me() { const r=await fetch("/api/panel/me"); return r.json(); },
      async login(password){ const r=await fetch("/api/panel/login",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({password})}); return r.json(); },
      async logout(){ await fetch("/api/panel/logout",{method:"POST"}); },

      async list(params={}) { const q=new URLSearchParams(params).toString(); const r=await fetch(`/api/listings${q?`?${q}`:""}`); return r.json(); },
      async get(id){ const r=await fetch(`/api/listings/${id}`); return r.json(); },

      async create(fd){ const r=await fetch(`/api/listings`,{method:"POST",body:fd}); return r.json(); },
      async update(id, fd){ const r=await fetch(`/api/listings/${id}`,{method:"PUT",body:fd}); return r.json(); },
      async del(id){ const r=await fetch(`/api/listings/${id}`,{method:"DELETE"}); return r.json(); },
      async delImage(id){ const r=await fetch(`/api/images/${id}`,{method:"DELETE"}); return r.json(); },
      imageUrl(id){ return `/api/images/${id}`; }
    };

    // ---------- ICONS ----------
    const Icon = ({ name, className }) => {
      const icons = {
        MapPin: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></>,
        Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
        ChevronLeft: <path d="m15 18-6-6 6-6" />,
        X: <><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>,
        Languages: <><path d="m5 8 6 6" /><path d="m4 14 6-6 2-3" /><path d="M2 5h12" /><path d="M7 2h1" /><path d="m22 22-5-10-5 10" /><path d="M14 18h6" /></>,
        LogIn: <><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" /><polyline points="10 17 15 12 10 7" /><line x1="15" x2="3" y1="12" y2="12" /></>,
        LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></>,
        UserPlus: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><line x1="19" x2="19" y1="8" y2="14" /><line x1="22" x2="16" y1="11" y2="11" /></>,
        Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
      };
      return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={cn("h-4 w-4", className)}>{icons[name]}</svg>;
    };

    // ---------- UI ----------
    const Button = ({ variant = 'default', size = 'default', className, children, ...props }) => {
      const variants = { 
        default: "bg-blue-600 text-white hover:bg-blue-700",
        destructive: "bg-red-500 text-white hover:bg-red-600", 
        outline: "border border-zinc-200 bg-transparent hover:bg-blue-50",
        secondary: "bg-blue-100 text-blue-800 hover:bg-blue-200",
        ghost: "hover:bg-blue-100",
        link: "text-blue-600 underline-offset-4 hover:underline",
      };
      const sizes = { default: "h-10 px-4 py-2", sm: "h-9 rounded-md px-3", lg: "h-11 rounded-md px-8", icon: "h-10 w-10", };
      return <button className={cn("inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors disabled:opacity-50 disabled:pointer-events-none", variants[variant], sizes[size], className)} {...props}>{children}</button>;
    };
    const Card = ({ className, children }) => <div className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)}>{children}</div>;
    const CardHeader = ({ className, children }) => <div className={cn("flex flex-col space-y-1.5 p-6", className)}>{children}</div>;
    const CardTitle = ({ className, children }) => <h3 className={cn("text-2xl font-semibold leading-none tracking-tight", className)}>{children}</h3>;
    const CardContent = ({ className, children }) => <div className={cn("p-6 pt-0", className)}>{children}</div>;
    const Input = ({ className, ...props }) => <input className={cn("flex h-10 w-full rounded-md border border-zinc-200 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-zinc-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-50", className)} {...props} />;
    const Badge = ({ variant = 'default', className, children }) => {
      const variants = { default: "border-transparent bg-blue-600 text-blue-50", secondary: "border-transparent bg-blue-100 text-blue-900" };
      return <div className={cn("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors", variants[variant], className)}>{children}</div>;
    };
    const Slider = ({ className, min = 0, max = 100, step = 1, defaultValue = [0, 100], onValueChange }) => {
      const [values, setValues] = useState(defaultValue);
      const rangeRef = useRef(null);
      useEffect(() => { setValues(defaultValue); }, [defaultValue]);
      const handleMouseMove = (e, thumbIndex) => {
        if (!rangeRef.current) return;
        const rect = rangeRef.current.getBoundingClientRect();
        const percent = clamp((e.clientX - rect.left) / rect.width, 0, 1);
        const newValue = Math.round((min + percent * (max - min)) / step) * step;
        let newValues = [...values];
        if (thumbIndex === 0) newValues[0] = Math.min(newValue, values[1] - step);
        else newValues[1] = Math.max(newValue, values[0] + step);
        setValues(newValues);
        onValueChange && onValueChange(newValues);
      };
      const handleMouseDown = (thumbIndex) => (e) => {
        const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
        const onMove = (moveE) => handleMouseMove(moveE, thumbIndex);
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      };
      const leftPercent = ((values[0] - min) / (max - min)) * 100;
      const rightPercent = ((values[1] - min) / (max - min)) * 100;
      return (
        <div ref={rangeRef} className={cn("relative flex items-center select-none touch-none w-full h-5 cursor-pointer", className)}>
          <div className="relative w-full h-1 bg-zinc-200 rounded-full">
            <div className="absolute h-full bg-blue-600 rounded-full" style={{ left: `${leftPercent}%`, right: `${100 - rightPercent}%` }} />
            <div onMouseDown={handleMouseDown(0)} className="absolute w-4 h-4 bg-white border-2 border-blue-600 rounded-full -top-1.5 transform -translate-x-1/2" style={{ left: `${leftPercent}%` }} />
            <div onMouseDown={handleMouseDown(1)} className="absolute w-4 h-4 bg-white border-2 border-blue-600 rounded-full -top-1.5 transform -translate-x-1/2" style={{ left: `${rightPercent}%` }} />
          </div>
        </div>
      );
    };

    // ---------- TEXTS ----------
    const dict = {
      pl: { nav: ["Oferty", "O nas", "Opinie", "Kontakt"], allOffers: "Wszystkie Oferty", filters: { location: "Lokalizacja", price: "Cena", area: "Metraż", rooms: "Pokoje", type: "Typ", newest: "Najnowsze", cheapest: "Najtańsze", featured: "Polecane", grid: "Siatka", list: "Lista", fav: "Ulubione", clear: "Wyczyść" } },
      en: { nav: ["Listings", "About", "Reviews", "Contact"], allOffers: "All Listings", filters: { location: "Location", price: "Price", area: "Area", rooms: "Rooms", type: "Type", newest: "Newest", cheapest: "Cheapest", featured: "Featured", grid: "Grid", list: "List", fav: "Favourites", clear: "Clear" } }
    };

    // ---------- HEADER ----------
    function Header({ lang, setLang, t }) {
      return (
        <header className="sticky top-0 z-50 backdrop-blur-xl bg-white/60 border-b border-zinc-200/70">
          <div className="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
            <a href="index.html" className="flex items-center gap-3">
              <img src="https://i.imgur.com/UwnwhuV.png" alt="Centrum nieruchomości Logo" className="h-12 w-12" />
              <div>
                <div className="font-semibold tracking-tight">Centrum nieruchomości</div>
                <div className="text-xs text-zinc-600">Zacharska Klaudia</div>
              </div>
            </a>
            <nav className="hidden md:flex items-center gap-6 text-sm">
              <a href="index.html#offers" className="relative py-1.5 after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-0.5 after:bg-blue-600 after:transition-all after:duration-250 hover:after:w-full">{t.nav[0]}</a>
              <a href="index.html#about" className="relative py-1.5 after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-0.5 after:bg-blue-600 after:transition-all after:duration-250 hover:after:w-full">{t.nav[1]}</a>
              <a href="index.html#testimonials" className="relative py-1.5 after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-0.5 after:bg-blue-600 after:transition-all after:duration-250 hover:after:w-full">{t.nav[2]}</a>
              <a href="index.html#contact" className="relative py-1.5 after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-0 after:h-0.5 after:bg-blue-600 after:transition-all after:duration-250 hover:after:w-full">{t.nav[3]}</a>
              <Button variant="secondary" className="shadow-sm">{t.allOffers}</Button>
              <LangToggle lang={lang} setLang={setLang} />
            </nav>
          </div>
        </header>
      );
    }
    function LangToggle({ lang, setLang }) { return <Button variant="ghost" className="gap-2" onClick={() => setLang(lang === "pl" ? "en" : "pl")}> <Icon name="Languages" /> {lang.toUpperCase()}</Button>; }

    // ---------- FOOTER ----------
    function Footer() {
      return (
        <footer className="py-10 border-t bg-white/60 backdrop-blur">
          <div className="mx-auto max-w-7xl px-4 flex flex-col items-center text-center gap-4 text-sm text-zinc-600">
            <div className="flex items-center gap-3">
              <img src="https://i.imgur.com/UwnwhuV.png" alt="Centrum nieruchomości Logo" className="h-10 w-10" />
              <div>
                <div className="font-semibold tracking-tight">© {new Date().getFullYear()} Centrum nieruchomości</div>
                <div className="text-xs text-zinc-600">Zacharska Klaudia</div>
              </div>
            </div>
            <div className="flex items-center gap-4"><a href="#" className="hover:text-blue-600">Polityka prywatności</a><a href="#" className="hover:text-blue-600">RODO</a></div>
          </div>
        </footer>
      );
    }

    // ---------- MODAL SZCZEGÓŁÓW Z GALERIĄ ----------
    function OfferDetailsModal({ offer, onClose }) {
      const [active, setActive] = useState(0);
      useEffect(() => { document.body.style.overflow='hidden'; return ()=>{ document.body.style.overflow='unset'; }; }, []);
      const imgs = offer.images || [];
      return (
        <div className="fixed inset-0 z-[100] bg-white animate-fade-in" onClick={onClose}>
          <div onClick={(e) => e.stopPropagation()} className="relative w-full h-full overflow-hidden flex flex-col md:flex-row">
            <button onClick={onClose} className="absolute top-4 right-4 z-10 p-2 rounded-full bg-zinc-100 text-zinc-800 hover:bg-zinc-200 transition-colors"><Icon name="X" className="h-6 w-6" /></button>

            <div className="w-full md:w-1/2 h-1/2 md:h-full flex flex-col">
              <div className="relative flex-1 bg-black/5">
                {imgs.length ? <img src={api.imageUrl(imgs[active].id)} alt={offer.title} className="h-full w-full object-cover"/> : <div className="h-full w-full grid place-items-center text-zinc-400">Brak zdjęć</div>}
                {imgs.length>1 && (
                  <div className="absolute inset-x-0 bottom-0 p-3 flex gap-2 overflow-x-auto bg-black/30">
                    {imgs.map((im,i)=>(
                      <button key={im.id} onClick={()=>setActive(i)} className={`h-14 w-20 rounded-md overflow-hidden border ${i===active?"border-white ring-2 ring-white":"border-transparent"}`}>
                        <img src={api.imageUrl(im.id)} className="h-full w-full object-cover"/>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>

            <div className="w-full md:w-1/2 p-8 overflow-y-auto">
              <Badge>{offer.type || "Nieruchomość"}</Badge>
              <h2 className="text-3xl font-bold mt-2">{offer.title}</h2>
              <div className="flex items-center gap-2 text-zinc-500 mt-1"><Icon name="MapPin" /> {offer.city}{offer.district?` • ${offer.district}`:""}{offer.street?` • ${offer.street}`:""}</div>
              <div className="text-4xl font-bold my-6">{currency(offer.price)}</div>
              <div className="grid grid-cols-2 gap-4 text-base border-t pt-6">
                <div className="font-semibold text-zinc-600">Metraż:</div> <div>{offer.area ?? "-"} m²</div>
                <div className="font-semibold text-zinc-600">Pokoje:</div> <div>{offer.rooms ?? "-"}</div>
                <div className="font-semibold text-zinc-600">Piętro:</div> <div>{offer.floor ?? "-"}</div>
                <div className="font-semibold text-zinc-600">Balkon:</div> <div>{offer.balcony ? "Tak" : "Nie"}</div>
                <div className="font-semibold text-zinc-600">Taras:</div> <div>{offer.terrace ? "Tak" : "Nie"}</div>
                <div className="font-semibold text-zinc-600">Ogród:</div> <div>{offer.garden ? "Tak" : "Nie"}</div>
              </div>
              {offer.description && <p className="mt-6 text-zinc-700 leading-relaxed border-t pt-6">{offer.description}</p>}
              <Button size="lg" className="w-full mt-8 rounded-xl">Skontaktuj się w sprawie oferty</Button>
            </div>
          </div>
        </div>
      );
    }

    // ---------- WIDOK LISTY DLA KLIENTA ----------
    function AllOffers({ t }) {
      const [query, setQuery] = useState("");
      const [city, setCity] = useState("");
      const [type, setType] = useState("");
      const [rooms, setRooms] = useState(0);
      const [area, setArea] = useState([30, 160]);
      const [price, setPrice] = useState([300000, 1500000]);
      const [sort, setSort] = useState("newest");
      const [grid, setGrid] = useState(true);
      const [data, setData] = useState([]);
      const [selectedOffer, setSelectedOffer] = useState(null);

      async function load() {
        const rows = await api.list({
          q: query || undefined, city: city || undefined, type: type || undefined, rooms: rooms || undefined,
          min_area: area[0], max_area: area[1], min_price: price[0], max_price: price[1],
        });
        let out=[...rows];
        if (sort === "cheapest") out.sort((a,b)=>a.price-b.price);
        else if (sort === "newest") out.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
        else if (sort === "featured") out.sort((a,b)=>(b.terrace?1:0)-(a.terrace?1:0)||new Date(b.created_at)-new Date(a.created_at));
        setData(out);
      }
      useEffect(()=>{ load(); }, []);
      useEffect(()=>{ const id=setTimeout(load,200); return ()=>clearTimeout(id); }, [query, city, type, rooms, area, price, sort]);

      const cities = Array.from(new Set(data.map(x=>x.city))).filter(Boolean);
      const types = Array.from(new Set(data.map(x=>x.type))).filter(Boolean);
      const resetFilters = () => { setQuery(""); setCity(""); setType(""); setRooms(0); setArea([30,160]); setPrice([300000,1500000]); setSort("newest"); };

      return (
        <>
          <section className="w-full py-10 min-h-screen">
            <div className="mx-auto max-w-7xl px-4">
              <div className="flex items-center justify-between gap-3">
                <div className="flex items-center gap-3">
                  <a href="index.html"><Button variant="outline" className="rounded-xl"><Icon name="ChevronLeft" className="mr-2" />Wróć</Button></a>
                  <h2 className="text-2xl md:text-3xl font-semibold tracking-tight">{t.allOffers}</h2>
                  <Badge variant="secondary">{data.length}</Badge>
                </div>
                <div className="hidden md:flex items-center gap-2">
                  <Button variant={grid ? "default" : "outline"} onClick={() => setGrid(true)} className="rounded-xl">{t.filters.grid}</Button>
                  <Button variant={!grid ? "default" : "outline"} onClick={() => setGrid(false)} className="rounded-xl">{t.filters.list}</Button>
                </div>
              </div>

              <div className="mt-6 grid md:grid-cols-12 gap-3 p-4 rounded-2xl bg-white/70 backdrop-blur border shadow-sm">
                <div className="md:col-span-3"><Input placeholder="Szukaj..." value={query} onChange={(e) => setQuery(e.target.value)} /></div>
                <select className="md:col-span-2 rounded-xl border p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500" value={city} onChange={(e)=>setCity(e.target.value)}>
                  <option value="">{t.filters.location}</option>
                  {cities.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <select className="md:col-span-2 rounded-xl border p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500" value={type} onChange={(e)=>setType(e.target.value)}>
                  <option value="">{t.filters.type}</option>
                  {types.map(tp => <option key={tp} value={tp}>{tp}</option>)}
                </select>
                <select className="md:col-span-2 rounded-xl border p-2 text-sm bg-white focus:ring-2 focus:ring-blue-500" value={rooms} onChange={(e)=>setRooms(Number(e.target.value))}>
                  <option value={0}>{t.filters.rooms}</option>
                  {[1,2,3,4,5].map(r => <option key={r} value={r}>{r}+</option>)}
                </select>
                <div className="md:col-span-6 px-2"><label className="text-xs text-zinc-500">{t.filters.area}: {area[0]}–{area[1]} m²</label><Slider defaultValue={area} min={20} max={200} step={5} onValueChange={(v)=>setArea(v)} /></div>
                <div className="md:col-span-6 px-2"><label className="text-xs text-zinc-500">{t.filters.price}: {currency(price[0])} – {currency(price[1])}</label><Slider defaultValue={price} min={200000} max={2000000} step={10000} onValueChange={(v)=>setPrice(v)} /></div>
                <div className="md:col-span-12 flex justify-end"><Button variant="ghost" onClick={resetFilters} className="rounded-xl"><Icon name="X" className="mr-2" />{t.filters.clear}</Button></div>
              </div>

              <div className={cn("mt-6 grid gap-4", grid ? "md:grid-cols-3" : "grid-cols-1")}>
                {data.map(item => (
                  <div key={item.id} className="cursor-pointer" onClick={async ()=>{ const full=await api.get(item.id); setSelectedOffer(full); }}>
                    {grid ? (
                      <Card className="overflow-hidden rounded-3xl border-zinc-200/70 bg-white/80 backdrop-blur-xl shadow-[0_20px_60px_-25px_rgba(0,0,0,0.15)] transition-transform duration-300 hover:-translate-y-1">
                        <div className="relative h-56">
                          {item.thumb_image_id ? <img src={api.imageUrl(item.thumb_image_id)} className="h-full w-full object-cover"/> : <div className="h-full w-full grid place-items-center text-zinc-400 bg-zinc-100">Brak zdjęcia</div>}
                          <Badge className="absolute left-3 top-3 bg-black/70 text-white backdrop-blur">{item.type || "Nieruchomość"}</Badge>
                        </div>
                        <CardHeader>
                          <CardTitle className="text-xl">{item.title}</CardTitle>
                          <div className="flex items-center gap-2 text-zinc-500 text-sm"><Icon name="MapPin" /> {item.city}{item.district?` • ${item.district}`:""} • {item.area ?? "-"} m² • {item.rooms ?? "-"} pokoje</div>
                        </CardHeader>
                        <CardContent className="flex items-center justify-between">
                          <div className="text-2xl font-semibold">{currency(item.price)}</div>
                          <Button variant="outline" className="rounded-xl">Szczegóły</Button>
                        </CardContent>
                      </Card>
                    ) : (
                      <div className="rounded-2xl overflow-hidden border bg-white/70 backdrop-blur shadow-sm hover:shadow-md transition-shadow">
                        <div className="flex gap-4 p-3">
                          <div className="h-28 w-40 rounded-xl overflow-hidden bg-zinc-100">
                            {item.thumb_image_id ? <img src={api.imageUrl(item.thumb_image_id)} className="h-full w-full object-cover"/> : <div className="h-full w-full grid place-items-center text-zinc-400">Brak</div>}
                          </div>
                          <div className="flex-1">
                            <div className="flex items-start justify-between">
                              <div>
                                <h4 className="font-semibold">{item.title}</h4>
                                <div className="text-sm text-zinc-500">{item.city}{item.district?` • ${item.district}`:""} • {item.area ?? "-"} m² • {item.rooms ?? "-"} pokoje • piętro {item.floor ?? "-"}</div>
                              </div>
                              <div className="text-xl font-semibold">{currency(item.price)}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </section>

          {selectedOffer && <OfferDetailsModal offer={selectedOffer} onClose={() => setSelectedOffer(null)} />}
        </>
      );
    }

    // ---------- PANEL ADMINA ----------
    function FilePicker({ files, setFiles, label="Wybierz zdjęcia (JPG/PNG)", multiple=true }) {
      const inputRef = React.useRef(null);
      return (
        <div>
          <input ref={inputRef} type="file" accept="image/*" multiple={multiple} className="hidden" onChange={(e)=>setFiles(Array.from(e.target.files||[]))}/>
          <Button type="button" className="rounded-xl" onClick={()=>inputRef.current?.click()}>{label}</Button>
          <div className="mt-2 text-xs text-zinc-500">{files.length ? `${files.length} plik(i)` : "Brak wybranych plików"}</div>
        </div>
      );
    }

    function ExistingImages({ listingId }) {
      const [imgs, setImgs] = useState([]);
      useEffect(()=>{ (async()=>{ const full = await api.get(listingId); setImgs(full.images||[]); })(); },[listingId]);
      if(!imgs.length) return null;
      return (
        <div className="col-span-2 mt-3">
          <div className="text-sm mb-2">Istniejące zdjęcia:</div>
          <div className="flex gap-2 flex-wrap">
            {imgs.map(im=>(
              <div key={im.id} className="relative w-24 h-16 rounded-md overflow-hidden border">
                <img src={api.imageUrl(im.id)} className="w-full h-full object-cover"/>
                <button type="button" onClick={async()=>{ if(confirm("Usunąć zdjęcie?")){ await api.delImage(im.id); const full=await api.get(listingId); setImgs(full.images||[]); }}} className="absolute top-1 right-1 bg-red-600 text-white text-xs px-1 rounded">X</button>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function AdminPanel() {
      const [auth, setAuth] = useState(false);
      const [password, setPassword] = useState("");
      const [list, setList] = useState([]);
      const [creating, setCreating] = useState(false);
      const [files, setFiles] = useState([]);

      const [form, setForm] = useState({
        title:"", city:"", district:"", street:"",
        price:"", rooms:"", area:"", type:"Mieszkanie", floor:"",
        balcony:false, terrace:false, garden:false, description:""
      });

      const [editId, setEditId] = useState(null);
      const [editFiles, setEditFiles] = useState([]);
      const [editForm, setEditForm] = useState({});

      async function load(){ const rows = await api.list(); setList(rows); }
      useEffect(()=>{ (async()=>{ const me=await api.me(); setAuth(me.authed); if(me.authed) load(); })(); },[]);

      if(!auth){
        return (
          <section className="w-full py-12">
            <div className="mx-auto max-w-sm px-4">
              <Card className="rounded-2xl">
                <CardHeader><CardTitle>Logowanie do panelu</CardTitle></CardHeader>
                <CardContent>
                  <form onSubmit={async(e)=>{e.preventDefault();const r=await api.login(password); if(r.ok){ setAuth(true); load(); } else alert(r.error||"Błąd"); }}>
                    <Input type="password" placeholder="Hasło" value={password} onChange={(e)=>setPassword(e.target.value)} />
                    <Button className="w-full mt-3">Zaloguj</Button>
                  </form>
                </CardContent>
              </Card>
            </div>
          </section>
        );
      }

      const onCreate = async (e) => {
        e.preventDefault(); setCreating(true);
        try{
          const fd=new FormData();
          Object.entries(form).forEach(([k,v])=>fd.append(k,String(v)));
          for(const f of files) fd.append("images", f);
          const r = await api.create(fd);
          if(r.ok){ setForm({ title:"", city:"", district:"", street:"", price:"", rooms:"", area:"", type:"Mieszkanie", floor:"", balcony:false, terrace:false, garden:false, description:"" }); setFiles([]); await load(); alert("Dodano ogłoszenie"); }
          else alert(r.error||"Błąd dodawania");
        } finally { setCreating(false); }
      };

      const startEdit = async (row) => {
        setEditId(row.id);
        const full = await api.get(row.id);
        setEditForm({
          title: full.title, city: full.city, district: full.district || "", street: full.street || "",
          price: full.price, rooms: full.rooms || "", area: full.area || "", type: full.type || "Mieszkanie", floor: full.floor || "",
          balcony: !!full.balcony, terrace: !!full.terrace, garden: !!full.garden, description: full.description || ""
        });
        setEditFiles([]);
      };

      const submitEdit = async (e) => {
        e.preventDefault();
        const fd = new FormData();
        Object.entries(editForm).forEach(([k,v])=>fd.append(k,String(v)));
        for(const f of editFiles) fd.append("images", f);
        const r = await api.update(editId, fd);
        if(r.ok){ setEditId(null); setEditFiles([]); await load(); alert("Zapisano zmiany"); }
        else alert(r.error||"Błąd zapisu");
      };

      return (
        <section className="w-full py-12">
          <div className="mx-auto max-w-7xl px-4 grid md:grid-cols-2 gap-8">
            <Card className="rounded-2xl">
              <CardHeader><CardTitle>Dodaj ogłoszenie</CardTitle></CardHeader>
              <CardContent>
                <form className="grid grid-cols-2 gap-3" onSubmit={onCreate}>
                  <Input placeholder="Tytuł" value={form.title} onChange={e=>setForm({...form, title:e.target.value})} className="col-span-2" required />
                  <Input placeholder="Miasto" value={form.city} onChange={e=>setForm({...form, city:e.target.value})} required />
                  <Input placeholder="Dzielnica" value={form.district} onChange={e=>setForm({...form, district:e.target.value})} />
                  <Input placeholder="Ulica" value={form.street} onChange={e=>setForm({...form, street:e.target.value})} />
                  <Input placeholder="Cena (PLN)" type="number" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} required />
                  <Input placeholder="Pokoje" type="number" value={form.rooms} onChange={e=>setForm({...form, rooms:e.target.value})} />
                  <Input placeholder="Metraż (m²)" type="number" value={form.area} onChange={e=>setForm({...form, area:e.target.value})} />
                  <Input placeholder="Piętro" type="number" value={form.floor} onChange={e=>setForm({...form, floor:e.target.value})} />
                  <Input placeholder="Typ (Mieszkanie/Dom/Apartament/Loft)" value={form.type} onChange={e=>setForm({...form, type:e.target.value})} />
                  <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={form.balcony} onChange={e=>setForm({...form, balcony:e.target.checked})}/> Balkon</label>
                  <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={form.terrace} onChange={e=>setForm({...form, terrace:e.target.checked})}/> Taras</label>
                  <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={form.garden} onChange={e=>setForm({...form, garden:e.target.checked})}/> Ogród</label>
                  <textarea placeholder="Opis" value={form.description} onChange={e=>setForm({...form, description:e.target.value})} className="col-span-2 rounded-md border p-2" />
                  <div className="col-span-2"><FilePicker files={files} setFiles={setFiles} /></div>
                  <Button className="col-span-2 rounded-xl" disabled={creating}>{creating ? "Zapisywanie..." : "Dodaj ogłoszenie"}</Button>
                </form>
              </CardContent>
            </Card>

            <Card className="rounded-2xl">
              <CardHeader><CardTitle>Twoje ogłoszenia</CardTitle></CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {list.map(row=>(
                    <div key={row.id} className="border rounded-xl p-3">
                      <div className="flex items-start justify-between">
                        <div>
                          <div className="font-semibold">{row.title}</div>
                          <div className="text-xs text-zinc-500">{row.city} {row.district?`• ${row.district}`:""} • {row.area ?? "-"} m² • {row.rooms ?? "-"} pok.</div>
                        </div>
                        <div className="flex gap-2">
                          <Button variant="outline" onClick={()=>startEdit(row)}>Edytuj</Button>
                          <Button variant="destructive" onClick={async()=>{ if(confirm("Usunąć ogłoszenie?")){ await api.del(row.id); await load(); } }}>Usuń</Button>
                        </div>
                      </div>

                      {editId===row.id && (
                        <form className="mt-3 grid grid-cols-2 gap-2" onSubmit={submitEdit}>
                          <Input placeholder="Tytuł" value={editForm.title} onChange={e=>setEditForm({...editForm, title:e.target.value})} className="col-span-2" />
                          <Input placeholder="Miasto" value={editForm.city} onChange={e=>setEditForm({...editForm, city:e.target.value})} />
                          <Input placeholder="Dzielnica" value={editForm.district} onChange={e=>setEditForm({...editForm, district:e.target.value})} />
                          <Input placeholder="Ulica" value={editForm.street} onChange={e=>setEditForm({...editForm, street:e.target.value})} />
                          <Input placeholder="Cena" type="number" value={editForm.price} onChange={e=>setEditForm({...editForm, price:e.target.value})} />
                          <Input placeholder="Pokoje" type="number" value={editForm.rooms} onChange={e=>setEditForm({...editForm, rooms:e.target.value})} />
                          <Input placeholder="Metraż" type="number" value={editForm.area} onChange={e=>setEditForm({...editForm, area:e.target.value})} />
                          <Input placeholder="Piętro" type="number" value={editForm.floor} onChange={e=>setEditForm({...editForm, floor:e.target.value})} />
                          <Input placeholder="Typ" value={editForm.type} onChange={e=>setEditForm({...editForm, type:e.target.value})} />
                          <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={!!editForm.balcony} onChange={e=>setEditForm({...editForm, balcony:e.target.checked})}/> Balkon</label>
                          <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={!!editForm.terrace} onChange={e=>setEditForm({...editForm, terrace:e.target.checked})}/> Taras</label>
                          <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={!!editForm.garden} onChange={e=>setEditForm({...editForm, garden:e.target.checked})}/> Ogród</label>
                          <textarea placeholder="Opis" value={editForm.description} onChange={e=>setEditForm({...editForm, description:e.target.value})} className="col-span-2 rounded-md border p-2" />
                          <div className="col-span-2"><FilePicker files={editFiles} setFiles={setEditFiles} label="Dodaj kolejne zdjęcia" /></div>
                          <div className="col-span-2 flex gap-2">
                            <Button type="submit">Zapisz</Button>
                            <Button type="button" variant="outline" onClick={()=>setEditId(null)}>Anuluj</Button>
                          </div>
                          <ExistingImages listingId={row.id} />
                        </form>
                      )}
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </div>
        </section>
      );
    }

    // ---------- ROOT APP ----------
    function App() {
      const [lang, setLang] = useState("pl");
      const t = dict[lang];
      const isPanel = typeof window !== "undefined" && window.location.pathname.endsWith("/panel");
      return (
        <div className="min-h-screen bg-gradient-to-b from-blue-50 via-white to-blue-50 text-zinc-900 selection:bg-blue-200 selection:text-blue-900">
          <Header t={t} lang={lang} setLang={setLang}/>
          <main>{isPanel ? <AdminPanel/> : <AllOffers t={t}/>}</main>
          <Footer/>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
