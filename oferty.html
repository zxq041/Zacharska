<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wszystkie oferty - Centrum nieruchomości</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .scrollbar-none::-webkit-scrollbar { display:none; } .scrollbar-none{ -ms-overflow-style:none; scrollbar-width:none; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} } .animate-fade-in{ animation: fadeIn .25s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-b from-blue-50 via-white to-blue-50 text-zinc-900">
  <div id="root"></div>

  <script type="text/babel">
  const {useEffect, useMemo, useRef, useState} = React;

  const API = {
    LIST: "/api/listings",
    IMAGE: (id)=> `/api/images/${id}`,
  };

  // ---------- UI helpers ----------
  const cn = (...a)=>a.filter(Boolean).join(' ');
  const currency = (n)=> new Intl.NumberFormat("pl-PL",{style:"currency",currency:"PLN", maximumFractionDigits:0}).format(n);

  const Button = ({variant='default', size='default', className, ...props})=>{
    const variants = {
      default: "bg-blue-600 text-white hover:bg-blue-700",
      outline: "border border-zinc-200 bg-white hover:bg-blue-50",
      ghost: "hover:bg-blue-50",
      danger:"bg-red-500 text-white hover:bg-red-600"
    };
    const sizes = { default:"h-10 px-4 py-2", sm:"h-9 px-3", lg:"h-11 px-6", icon:"h-10 w-10 p-0"};
    return <button className={cn("rounded-md text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed", variants[variant], sizes[size], className)} {...props} />;
  };
  const Card = ({className, ...p}) => <div className={cn("rounded-2xl border bg-white/80 backdrop-blur shadow-sm", className)} {...p}/>;
  const Input = (p)=> <input className={cn("w-full rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500", p.className)} {...p} />;
  const Textarea = (p)=> <textarea className={cn("w-full min-h-[90px] rounded-md border border-zinc-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500", p.className)} {...p} />;
  const Badge = ({children, className}) => <span className={cn("inline-flex items-center rounded-full bg-blue-100 text-blue-900 px-2.5 py-0.5 text-xs font-semibold",className)}>{children}</span>;

  const Icon = ({name, className})=>{
    const paths = {
      Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
      MapPin: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
      X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
      ChevronLeft: <path d="m15 18-6-6 6-6"/>,
      ChevronRight: <path d="m9 18 6-6-6-6"/>,
      Trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></>
    };
    return <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{paths[name]}</svg>;
  };

  // ---------- Header ----------
  const Header = ({isPanel})=>{
    return (
      <header className="sticky top-0 z-40 bg-white/70 backdrop-blur border-b">
        <div className="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
          <a href="/index.html" className="flex items-center gap-3">
            <img src="https://i.imgur.com/UwnwhuV.png" alt="logo" className="h-10 w-10"/>
            <div>
              <div className="font-semibold tracking-tight">Centrum nieruchomości</div>
              <div className="text-xs text-zinc-600">Zacharska Klaudia</div>
            </div>
          </a>
          <nav className="flex items-center gap-3 text-sm">
            {!isPanel && <a href="/oferty.html" className="text-zinc-700">Oferty</a>}
            {isPanel ? <Badge className="bg-emerald-100 text-emerald-800">Panel administratora</Badge> : <a className="text-zinc-700 hover:text-blue-600" href="/panel33201">Panel</a>}
          </nav>
        </div>
      </header>
    );
  };

  // ---------- Admin Panel ----------
  function AdminPanel(){
    const empty = {id:null,title:"",city:"",district:"",street:"",type:"Mieszkanie",floor:"",area:"",rooms:"",price:"",balcony:false,terrace:false,garden:false,description:""};
    const [form,setForm] = useState(empty);
    const [files,setFiles] = useState([]);
    const [list,setList] = useState([]);
    const [loading,setLoading] = useState(true);
    const [saving,setSaving] = useState(false);
    const [toRemove,setToRemove] = useState([]); // image ids to delete on PUT

    const load = ()=>{
      setLoading(true);
      fetch(API.LIST).then(r=>r.json()).then(setList).finally(()=>setLoading(false));
    };
    useEffect(load,[]);

    const onPickFiles = (e)=> setFiles(Array.from(e.target.files || []));

    const startEdit = (row)=>{
      setForm({
        id: row.id, title:row.title, city:row.city, district:row.district||"",
        street:row.street||"", type:row.type, floor:row.floor??"",
        area:row.area, rooms:row.rooms, price:row.price,
        balcony: !!row.balcony, terrace: !!row.terrace, garden: !!row.garden,
        description: row.description||""
      });
      setToRemove([]);
      setFiles([]);
      window.scrollTo({top:0,behavior:'smooth'});
    };

    const reset = ()=>{ setForm(empty); setFiles([]); setToRemove([]); };

    const submit = async (e)=>{
      e.preventDefault();
      setSaving(true);
      try{
        const fd = new FormData();
        Object.entries(form).forEach(([k,v])=>{
          if (k==="id") return;
          fd.append(k, typeof v==="boolean" ? String(v) : v);
        });
        files.forEach(f=> fd.append("images", f));
        if (form.id){ // PUT
          if (toRemove.length) fd.append("remove_images", JSON.stringify(toRemove));
          const r = await fetch(`${API.LIST}/${form.id}`, { method:"PUT", body: fd });
          if (!r.ok) throw new Error("PUT fail");
        } else {       // POST
          const r = await fetch(API.LIST, { method:"POST", body: fd });
          if (!r.ok) throw new Error("POST fail");
        }
        reset();
        load();
      }catch(err){ alert("Błąd zapisu"); console.error(err); }
      finally{ setSaving(false); }
    };

    const del = async (id)=>{
      if(!confirm("Usunąć ogłoszenie?")) return;
      await fetch(`${API.LIST}/${id}`,{method:"DELETE"});
      if (form.id===id) reset();
      load();
    };

    const toggleRemoveImg = (imgId)=>{
      setToRemove(prev => prev.includes(imgId) ? prev.filter(x=>x!==imgId) : [...prev, imgId]);
    };

    return (
      <main className="mx-auto max-w-7xl px-4 py-8">
        <h1 className="text-2xl font-semibold mb-4">Dodaj / Edytuj ogłoszenie</h1>

        <Card className="p-4">
          <form onSubmit={submit} className="grid md:grid-cols-2 gap-4">
            <Input placeholder="Tytuł" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} required/>
            <Input placeholder="Miasto" value={form.city} onChange={e=>setForm({...form,city:e.target.value})} required/>
            <Input placeholder="Dzielnica" value={form.district} onChange={e=>setForm({...form,district:e.target.value})}/>
            <Input placeholder="Ulica" value={form.street} onChange={e=>setForm({...form,street:e.target.value})}/>
            <select className="rounded-md border border-zinc-300 px-3 py-2 text-sm" value={form.type} onChange={e=>setForm({...form,type:e.target.value})}>
              <option>Mieszkanie</option><option>Dom</option><option>Apartament</option><option>Loft</option>
            </select>
            <Input type="number" placeholder="Piętro" value={form.floor} onChange={e=>setForm({...form,floor:e.target.value})}/>
            <Input type="number" placeholder="Metraż (m²)" value={form.area} onChange={e=>setForm({...form,area:e.target.value})} required/>
            <Input type="number" placeholder="Pokoje" value={form.rooms} onChange={e=>setForm({...form,rooms:e.target.value})} required/>
            <Input type="number" placeholder="Cena (PLN)" value={form.price} onChange={e=>setForm({...form,price:e.target.value})} required/>

            <div className="flex items-center gap-4 col-span-2">
              <label className="flex items-center gap-2"><input type="checkbox" checked={form.balcony} onChange={e=>setForm({...form,balcony:e.target.checked})}/> Balkon</label>
              <label className="flex items-center gap-2"><input type="checkbox" checked={form.terrace} onChange={e=>setForm({...form,terrace:e.target.checked})}/> Taras</label>
              <label className="flex items-center gap-2"><input type="checkbox" checked={form.garden} onChange={e=>setForm({...form,garden:e.target.checked})}/> Ogród</label>
            </div>

            <Textarea className="md:col-span-2" placeholder="Opis" value={form.description} onChange={e=>setForm({...form,description:e.target.value})}/>

            <div className="md:col-span-2">
              <label className="block text-sm font-medium mb-1">Zdjęcia (możesz wybrać wiele)</label>
              <label className="inline-block cursor-pointer rounded-md border px-4 py-2 text-sm bg-white hover:bg-blue-50">
                Wybierz pliki
                <input type="file" className="hidden" multiple accept="image/*" onChange={onPickFiles}/>
              </label>
              {files.length>0 && <div className="text-xs text-zinc-500 mt-1">{files.length} plik(i) wybrane</div>}
            </div>

            {form.id && (
              <div className="md:col-span-2">
                <div className="text-sm font-medium mb-1">Zdjęcia już w ogłoszeniu (zaznacz, aby usunąć):</div>
                <div className="flex flex-wrap gap-3">
                  {(list.find(x=>x.id===form.id)?.image_ids || []).map(imgId=>(
                    <label key={imgId} className={cn("relative block", toRemove.includes(imgId) && "opacity-60")}>
                      <img src={API.IMAGE(imgId)} className="h-24 w-32 object-cover rounded-md border" />
                      <input type="checkbox" className="absolute top-1 left-1 h-4 w-4" checked={toRemove.includes(imgId)} onChange={()=>toggleRemoveImg(imgId)}/>
                    </label>
                  ))}
                  {(!list.find(x=>x.id===form.id)?.image_ids?.length) && <div className="text-sm text-zinc-500">Brak zdjęć.</div>}
                </div>
              </div>
            )}

            <div className="md:col-span-2 flex gap-2">
              <Button type="submit" disabled={saving}>{form.id ? "Zapisz zmiany" : "Dodaj ogłoszenie"}</Button>
              {form.id && <Button type="button" variant="outline" onClick={reset}>Anuluj edycję</Button>}
            </div>
          </form>
        </Card>

        <h2 className="text-xl font-semibold mt-8 mb-3">Twoje ogłoszenia</h2>
        {loading ? <div>Ładowanie…</div> : (
          <div className="grid md:grid-cols-3 gap-4">
            {list.map(it=>(
              <Card key={it.id} className="overflow-hidden">
                <div className="h-40 bg-zinc-100">
                  {it.image_ids?.length ? <img src={API.IMAGE(it.image_ids[0])} className="h-full w-full object-cover"/> : <div className="h-full w-full flex items-center justify-center text-zinc-400">Brak zdjęcia</div>}
                </div>
                <div className="p-4 space-y-2">
                  <div className="font-semibold">{it.title}</div>
                  <div className="text-sm text-zinc-600">{it.city}{it.district ? " • "+it.district : ""} • {it.area} m² • {it.rooms} pokoje</div>
                  <div className="font-semibold">{currency(it.price)}</div>
                  <div className="flex gap-2 pt-2">
                    <Button variant="outline" onClick={()=>startEdit(it)}>Edytuj</Button>
                    <Button variant="danger" onClick={()=>del(it.id)}><Icon name="Trash" className="inline -mt-0.5 mr-1"/>Usuń</Button>
                  </div>
                </div>
              </Card>
            ))}
          </div>
        )}
      </main>
    );
  }

  // ---------- Public list ----------
  function PublicList(){
    const [list,setList] = useState([]);
    const [q,setQ] = useState("");
    const [city,setCity] = useState("");
    const [type,setType] = useState("");
    const [selected,setSelected] = useState(null);

    useEffect(()=>{
      fetch(API.LIST).then(r=>r.json()).then(setList);
    },[]);

    const filtered = useMemo(()=>{
      return list.filter(x =>
        x.title.toLowerCase().includes(q.toLowerCase()) &&
        (!city || x.city===city) &&
        (!type || x.type===type)
      );
    },[list,q,city,type]);

    return (
      <main className="mx-auto max-w-7xl px-4 py-8">
        <div className="flex items-center gap-3">
          <a href="/index.html" className="inline-flex items-center gap-2 text-sm text-zinc-700 hover:text-blue-600">
            <Icon name="ChevronLeft"/> Wróć
          </a>
          <h1 className="text-2xl font-semibold">Wszystkie Oferty</h1>
          <Badge className="ml-2">{filtered.length}</Badge>
        </div>

        <div className="mt-4 grid md:grid-cols-12 gap-3 p-4 bg-white/70 backdrop-blur rounded-2xl border">
          <div className="md:col-span-5"><Input placeholder="Szukaj tytułu…" value={q} onChange={e=>setQ(e.target.value)}/></div>
          <div className="md:col-span-3">
            <select className="w-full rounded-md border border-zinc-300 px-3 py-2 text-sm" value={city} onChange={e=>setCity(e.target.value)}>
              <option value="">Miasto</option>
              {[...new Set(list.map(x=>x.city))].map(c=><option key={c}>{c}</option>)}
            </select>
          </div>
          <div className="md:col-span-3">
            <select className="w-full rounded-md border border-zinc-300 px-3 py-2 text-sm" value={type} onChange={e=>setType(e.target.value)}>
              <option value="">Typ</option>
              {[...new Set(list.map(x=>x.type))].map(t=><option key={t}>{t}</option>)}
            </select>
          </div>
          <div className="md:col-span-1 flex items-center justify-end">
            <a href="/panel33201" className="text-xs text-zinc-500 hover:text-blue-600">/panel</a>
          </div>
        </div>

        <div className="mt-6 grid md:grid-cols-3 gap-4">
          {filtered.map(item=>(
            <div key={item.id} className="group cursor-pointer" onClick={()=>setSelected(item)}>
              <Card className="overflow-hidden shadow-[0_20px_60px_-25px_rgba(0,0,0,.15)] transition-transform group-hover:-translate-y-1">
                <div className="h-56 bg-zinc-100">
                  {item.image_ids?.length ? <img src={API.IMAGE(item.image_ids[0])} className="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"/> : <div className="h-full w-full flex items-center justify-center text-zinc-400">Brak zdjęcia</div>}
                </div>
                <div className="p-4">
                  <div className="text-lg font-semibold">{item.title}</div>
                  <div className="text-sm text-zinc-600 flex items-center gap-2">
                    <Icon name="MapPin"/> {item.city}{item.district ? " • "+item.district : ""} • {item.area} m² • {item.rooms} pokoje
                  </div>
                  <div className="mt-2 text-xl font-semibold">{currency(item.price)}</div>
                </div>
              </Card>
            </div>
          ))}
        </div>

        {selected && <OfferModal data={selected} onClose={()=>setSelected(null)} />}
      </main>
    );
  }

  // ---------- Offer details modal (gallery) ----------
  function OfferModal({data,onClose}){
    const [idx,setIdx] = useState(0);
    const imgs = data.image_ids || [];
    useEffect(()=>{ document.body.style.overflow='hidden'; return ()=>{document.body.style.overflow='unset'}; },[]);
    const prev = ()=> setIdx(i => (i-1+imgs.length)%imgs.length);
    const next = ()=> setIdx(i => (i+1)%imgs.length);

    return (
      <div className="fixed inset-0 bg-black/70 z-50 animate-fade-in" onClick={onClose}>
        <div className="absolute inset-6 md:inset-12 bg-white rounded-2xl overflow-hidden" onClick={e=>e.stopPropagation()}>
          <button className="absolute top-3 right-3 rounded-full bg-white/90 p-2 hover:bg-white" onClick={onClose}><Icon name="X"/></button>
          <div className="grid md:grid-cols-2 h-full">
            <div className="relative bg-zinc-100">
              {imgs.length ? <img src={API.IMAGE(imgs[idx])} className="h-full w-full object-cover"/> : <div className="h-full w-full flex items-center justify-center text-zinc-400">Brak zdjęć</div>}
              {imgs.length>1 && (
                <>
                  <button className="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 rounded-full p-2" onClick={prev}><Icon name="ChevronLeft"/></button>
                  <button className="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 rounded-full p-2" onClick={next}><Icon name="ChevronRight"/></button>
                  <div className="absolute bottom-2 left-0 right-0 flex gap-2 justify-center px-3">
                    {imgs.map((id,i)=>(
                      <img key={id} src={API.IMAGE(id)} onClick={()=>setIdx(i)} className={cn("h-14 w-20 object-cover rounded-md border cursor-pointer", i===idx ? "ring-2 ring-blue-500" : "opacity-80")} />
                    ))}
                  </div>
                </>
              )}
            </div>
            <div className="p-6 overflow-y-auto">
              <Badge>{data.type}</Badge>
              <h2 className="text-2xl font-bold mt-2">{data.title}</h2>
              <div className="text-zinc-600 mt-1 flex items-center gap-2"><Icon name="MapPin"/>{data.city}{data.district ? " • "+data.district : ""}{data.street ? " • "+data.street : ""}</div>
              <div className="text-3xl font-bold my-6">{currency(data.price)}</div>
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div className="text-zinc-500">Metraż:</div><div className="font-medium">{data.area} m²</div>
                <div className="text-zinc-500">Pokoje:</div><div className="font-medium">{data.rooms}</div>
                <div className="text-zinc-500">Piętro:</div><div className="font-medium">{data.floor ?? "-"}</div>
                <div className="text-zinc-500">Balkon:</div><div className="font-medium">{data.balcony ? "Tak" : "Nie"}</div>
                <div className="text-zinc-500">Taras:</div><div className="font-medium">{data.terrace ? "Tak" : "Nie"}</div>
                <div className="text-zinc-500">Ogród:</div><div className="font-medium">{data.garden ? "Tak" : "Nie"}</div>
              </div>
              {data.description && <p className="mt-6 leading-relaxed text-zinc-700">{data.description}</p>}
              <Button className="w-full mt-8">Skontaktuj się w sprawie oferty</Button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ---------- App root ----------
  function App(){
    const isPanel = window.location.pathname.endsWith("/panel33201");
    return (
      <div>
        <Header isPanel={isPanel}/>
        {isPanel ? <AdminPanel/> : <PublicList/>}
        <footer className="py-10 border-t bg-white/60 backdrop-blur mt-10">
          <div className="mx-auto max-w-7xl px-4 flex flex-col items-center text-center gap-3 text-sm text-zinc-600">
            <div className="flex items-center gap-3">
              <img src="https://i.imgur.com/UwnwhuV.png" className="h-10 w-10" />
              <div>
                <div className="font-semibold">© {new Date().getFullYear()} Centrum nieruchomości</div>
                <div className="text-xs">Zacharska Klaudia</div>
              </div>
            </div>
          </div>
        </footer>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
