<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wszystkie oferty - Centrum nieruchomości</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useEffect, useMemo, useRef, useState } = React;

// ---------- UTILITIES ----------
const cn = (...classes) => classes.filter(Boolean).join(' ');
const clamp = (n, min, max) => Math.max(min, Math.min(n, max));
const currency = (n) => new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN", maximumFractionDigits: 0 }).format(n);
const useLocalStorage = (key, initial) => {
  const [state, setState] = useState(() => {
    try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial } catch { return initial }
  });
  useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)) } catch {} }, [key, state]);
  return [state, setState];
};

// ---------- ICONS ----------
const Icon = ({ name, className }) => {
  const icons = {
    MapPin: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></>,
    Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />,
    Mail: <><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></>,
    Menu: <><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>,
    Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
    ChevronLeft: <path d="m15 18-6-6 6-6" />,
    X: <><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>,
    Languages: <><path d="m5 8 6 6" /><path d="m4 14 6-6 2-3" /><path d="M2 5h12" /><path d="M7 2h1" /><path d="m22 22-5-10-5 10" /><path d="M14 18h6" /></>,
    Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
    Trash: <path d="M3 6h18M8 6V4h8v2m-1 0v12a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V6h10z"/>
  };
  return <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={cn("h-4 w-4", className)}>{icons[name]}</svg>;
};

// ---------- UI ----------
const Button = ({ variant = 'default', size = 'default', className, children, ...props }) => {
  const variants = { 
    default: "bg-blue-600 text-white hover:bg-blue-700",
    destructive: "bg-red-500 text-white hover:bg-red-600", 
    outline: "border border-zinc-200 bg-transparent hover:bg-blue-50",
    secondary: "bg-blue-100 text-blue-800 hover:bg-blue-200",
    ghost: "hover:bg-blue-100",
  };
  const sizes = { default: "h-10 px-4 py-2", sm: "h-9 rounded-md px-3", lg: "h-11 rounded-md px-8", icon: "h-10 w-10" };
  return <button className={cn("inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors disabled:opacity-50 disabled:pointer-events-none", variants[variant], sizes[size], className)} {...props}>{children}</button>;
};
const Card = ({ className, children }) => <div className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)}>{children}</div>;
const CardHeader = ({ className, children }) => <div className={cn("flex flex-col space-y-1.5 p-6", className)}>{children}</div>;
const CardTitle = ({ className, children }) => <h3 className={cn("text-2xl font-semibold leading-none tracking-tight", className)}>{children}</h3>;
const CardContent = ({ className, children }) => <div className={cn("p-6 pt-0", className)}>{children}</div>;
const Input = ({ className, ...props }) => <input className={cn("flex h-10 w-full rounded-md border border-zinc-200 bg-white px-3 py-2 text-sm ring-offset-white placeholder:text-zinc-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500", className)} {...props} />;
const Switch = () => <button type="button" role="switch" className="peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent bg-zinc-200 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 data-[state=checked]:bg-blue-600"><span className="pointer-events-none block h-5 w-5 rounded-full bg-white shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0" /></button>;
const Badge = ({ variant = 'default', className, children }) => {
  const variants = { default: "border-transparent bg-blue-600 text-blue-50", secondary: "border-transparent bg-blue-100 text-blue-900" };
  return <div className={cn("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors", variants[variant], className)}>{children}</div>;
};
const Slider = ({ className, min = 0, max = 100, step = 1, defaultValue = [0, 100], onValueChange }) => {
  const [values, setValues] = useState(defaultValue);
  const rangeRef = useRef(null);
  useEffect(() => { setValues(defaultValue); }, [defaultValue]);
  const handleMouseMove = (e, thumbIndex) => {
    if (!rangeRef.current) return;
    const rect = rangeRef.current.getBoundingClientRect();
    const percent = clamp((e.clientX - rect.left) / rect.width, 0, 1);
    const newValue = Math.round((min + percent * (max - min)) / step) * step;
    let newValues = [...values];
    if (thumbIndex === 0) newValues[0] = Math.min(newValue, values[1] - step);
    else newValues[1] = Math.max(newValue, values[0] + step);
    setValues(newValues);
    onValueChange?.(newValues);
  };
  const handleMouseDown = (thumbIndex) => (e) => {
    const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
    const onMove = (moveE) => handleMouseMove(moveE, thumbIndex);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  };
  const leftPercent = ((values[0] - min) / (max - min)) * 100;
  const rightPercent = ((values[1] - min) / (max - min)) * 100;
  return (
    <div ref={rangeRef} className={cn("relative flex items-center select-none touch-none w-full h-5 cursor-pointer", className)}>
      <div className="relative w-full h-1 bg-zinc-200 rounded-full">
        <div className="absolute h-full bg-blue-600 rounded-full" style={{ left: `${leftPercent}%`, right: `${100 - rightPercent}%` }} />
        <div onMouseDown={handleMouseDown(0)} className="absolute w-4 h-4 bg-white border-2 border-blue-600 rounded-full -top-1.5 transform -translate-x-1/2" style={{ left: `${leftPercent}%` }} />
        <div onMouseDown={handleMouseDown(1)} className="absolute w-4 h-4 bg-white border-2 border-blue-600 rounded-full -top-1.5 transform -translate-x-1/2" style={{ left: `${rightPercent}%` }} />
      </div>
    </div>
  );
};

// ---------- API ----------
async function apiGetListings(q = '') {
  const res = await fetch(`/api/listings${q ? `?q=${encodeURIComponent(q)}` : ''}`);
  return res.json();
}
async function apiAddListing(formData, pass) {
  const res = await fetch('/api/listings', {
    method: 'POST',
    headers: { 'x-admin-pass': pass }, // UWAGA: przy FormData NIE ustawiamy Content-Type
    body: formData
  });
  if (!res.ok) throw new Error((await res.json()).error || 'Błąd zapisu');
  return res.json();
}
async function apiDeleteListing(id, pass) {
  const res = await fetch(`/api/listings/${id}`, {
    method: 'DELETE',
    headers: { 'x-admin-pass': pass }
  });
  if (!res.ok) throw new Error('Błąd usuwania');
  return res.json();
}

// ---------- ROOT APP ----------
function App() {
  const [lang, setLang] = useState("pl");
  const [menuOpen, setMenuOpen] = useState(false);
  const [favs, setFavs] = useLocalStorage("favs", []);
  const [adminPass, setAdminPass] = useLocalStorage("admin-pass", ""); // trzymamy w localStorage

  const isPanel = window.location.pathname === '/panel';
  const goBack = () => { window.location.href = '/'; };

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 via-white to-blue-50 text-zinc-900">
      <Header lang={lang} setLang={setLang} menuOpen={menuOpen} setMenuOpen={setMenuOpen} />
      <main>
        {isPanel ? (
          <AdminGate adminPass={adminPass} setAdminPass={setAdminPass} />
        ) : (
          <AllOffers favs={favs} setFavs={setFavs} onBack={goBack} />
        )}
      </main>
      <Footer />
    </div>
  );
}

// ---------- HEADER ----------
function Header({ lang, setLang, menuOpen, setMenuOpen }) {
  return (
    <header className="sticky top-0 z-50 backdrop-blur-xl bg-white/60 border-b border-zinc-200/70">
      <div className="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
        <a href="/" className="flex items-center gap-3">
          <img src="https://i.imgur.com/UwnwhuV.png" alt="Logo" className="h-12 w-12" />
          <div>
            <div className="font-semibold tracking-tight">Centrum nieruchomości</div>
            <div className="text-xs text-zinc-600">Zacharska Klaudia</div>
          </div>
        </a>
        <nav className="hidden md:flex items-center gap-6 text-sm">
          <a href="/oferty" className="relative py-1.5">Wszystkie Oferty</a>
          <Button variant="ghost" className="gap-2" onClick={() => setLang(lang === "pl" ? "en" : "pl")}> <Icon name="Languages" /> {lang.toUpperCase()}</Button>
        </nav>
        <div className="md:hidden flex items-center gap-2">
          <Button variant="ghost" className="gap-2" onClick={() => setLang(lang === "pl" ? "en" : "pl")}> <Icon name="Languages" /> {lang.toUpperCase()}</Button>
          <Button variant="outline" size="icon" className="rounded-xl" onClick={() => setMenuOpen(!menuOpen)}>
            <Icon name="Menu" className="h-5 w-5" />
          </Button>
        </div>
      </div>
    </header>
  );
}

// ---------- LISTA OFERT ----------
function AllOffers({ favs, setFavs, onBack }) {
  const [query, setQuery] = useState("");
  const [list, setList] = useState([]);
  const [grid, setGrid] = useState(true);
  const [area, setArea] = useState([20, 200]);
  const [price, setPrice] = useState([200000, 2000000]);
  const [city, setCity] = useState("");
  const [type, setType] = useState("");
  const [rooms, setRooms] = useState(0);
  const [sort, setSort] = useState("newest");
  const [selected, setSelected] = useState(null);

  useEffect(() => { (async () => setList(await apiGetListings()))(); }, []);

  const filtered = useMemo(() => {
    let out = list.filter(x =>
      x.title.toLowerCase().includes(query.toLowerCase()) &&
      (!city || x.city === city) &&
      (!type || x.type === type) &&
      (rooms ? x.rooms >= rooms : true) &&
      x.area >= area[0] && x.area <= area[1] &&
      x.price >= price[0] && x.price <= price[1]
    );
    if (sort === "cheapest") out.sort((a,b)=> a.price - b.price);
    else out.sort((a,b)=> (sort==="newest" ? b.createdAt - a.createdAt : 0));
    return out;
  }, [list, query, city, type, rooms, area, price, sort]);

  const toggleFav = id => setFavs(prev => prev.includes(id) ? prev.filter(x=>x!==id) : [...prev, id]);

  return (
    <section className="w-full py-10 min-h-screen">
      <div className="mx-auto max-w-7xl px-4">
        <div className="flex items-center justify-between gap-3">
          <div className="flex items-center gap-3">
            <Button variant="outline" onClick={onBack} className="rounded-xl"><Icon name="ChevronLeft" className="mr-2" />Wróć</Button>
            <h2 className="text-2xl md:text-3xl font-semibold tracking-tight">Wszystkie Oferty</h2>
            <Badge variant="secondary">{filtered.length}</Badge>
          </div>
          <div className="hidden md:flex items-center gap-2">
            <Button variant={grid ? "default" : "outline"} onClick={() => setGrid(true)} className="rounded-xl">Siatka</Button>
            <Button variant={!grid ? "default" : "outline"} onClick={() => setGrid(false)} className="rounded-xl">Lista</Button>
          </div>
        </div>

        {/* filtry */}
        <div className="mt-6 grid md:grid-cols-12 gap-3 p-4 rounded-2xl bg-white/70 backdrop-blur border shadow-sm">
          <div className="md:col-span-3"><Input placeholder="Szukaj..." value={query} onChange={e=>setQuery(e.target.value)} /></div>
          <select className="md:col-span-2 rounded-xl border p-2 text-sm bg-white" value={city} onChange={e=>setCity(e.target.value)}>
            <option value="">Lokalizacja</option>
            {[...new Set(list.map(x=>x.city).filter(Boolean))].map(c=><option key={c} value={c}>{c}</option>)}
          </select>
          <select className="md:col-span-2 rounded-xl border p-2 text-sm bg-white" value={type} onChange={e=>setType(e.target.value)}>
            <option value="">Typ</option>
            {[...new Set(list.map(x=>x.type).filter(Boolean))].map(c=><option key={c} value={c}>{c}</option>)}
          </select>
          <select className="md:col-span-2 rounded-xl border p-2 text-sm bg-white" value={rooms} onChange={e=>setRooms(Number(e.target.value))}>
            <option value={0}>Pokoje</option>{[1,2,3,4,5].map(r=><option key={r} value={r}>{r}+</option>)}
          </select>
          <select className="md:col-span-2 rounded-xl border p-2 text-sm bg-white" value={sort} onChange={e=>setSort(e.target.value)}>
            <option value="newest">Najnowsze</option><option value="cheapest">Najtańsze</option>
          </select>
          <div className="md:col-span-6 px-2"><label className="text-xs text-zinc-500">Metraż: {area[0]}–{area[1]} m²</label><Slider defaultValue={area} min={20} max={200} step={5} onValueChange={setArea} /></div>
          <div className="md:col-span-6 px-2"><label className="text-xs text-zinc-500">Cena: {currency(price[0])} – {currency(price[1])}</label><Slider defaultValue={price} min={200000} max={2000000} step={10000} onValueChange={setPrice} /></div>
        </div>

        {/* kafelki */}
        <div className={cn("mt-6 grid gap-4", grid ? "md:grid-cols-3" : "grid-cols-1")}>
          {filtered.map(item => (
            <div key={item.id} className="rounded-3xl overflow-hidden border bg-white/70 backdrop-blur shadow-sm">
              <img src={item.image} alt={item.title} className="h-56 w-full object-cover" />
              <div className="p-4">
                <div className="flex items-center justify-between">
                  <h4 className="font-semibold text-lg">{item.title}</h4>
                  <div className="text-2xl font-semibold">{currency(item.price)}</div>
                </div>
                <div className="text-sm text-zinc-500 mt-1">{item.city}{item.district?` • ${item.district}`:''} • {item.area} m² • {item.rooms} pokoje</div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
}

// ---------- PANEL: bramka hasłem ----------
function AdminGate({ adminPass, setAdminPass }) {
  const [input, setInput] = useState('');
  const [ok, setOk] = useState(!!adminPass);

  const submit = (e) => {
    e.preventDefault();
    if (!input) return;
    // Po stronie serwera i tak weryfikujemy nagłówek. Tu tylko "wpuszczamy" do panelu.
    setAdminPass(input);
    setOk(true);
  };

  return ok ? <AdminPanel adminPass={adminPass || input}/> : (
    <section className="w-full py-16">
      <div className="mx-auto max-w-md px-4">
        <Card className="rounded-3xl bg-white/80 backdrop-blur">
          <CardHeader><CardTitle>Panel administratora</CardTitle></CardHeader>
          <CardContent>
            <form onSubmit={submit} className="space-y-3">
              <Input type="password" placeholder="Hasło" value={input} onChange={e=>setInput(e.target.value)} />
              <Button type="submit" className="w-full">Zaloguj</Button>
              <p className="text-xs text-zinc-500 mt-2">Podaj hasło aby przejść do panelu.</p>
            </form>
          </CardContent>
        </Card>
      </div>
    </section>
  );
}

// ---------- PANEL: formularz dodawania + lista i usuwanie ----------
function AdminPanel({ adminPass }) {
  const [list, setList] = useState([]);
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState('');

  useEffect(() => { (async () => setList(await apiGetListings()))(); }, []);

  async function add(e) {
    e.preventDefault();
    setErr('');
    setBusy(true);
    try {
      const fd = new FormData(e.target);
      const created = await apiAddListing(fd, adminPass);
      setList((prev) => [created, ...prev]);
      e.target.reset();
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setBusy(false);
    }
  }

  async function remove(id) {
    if (!confirm('Usunąć ogłoszenie?')) return;
    try {
      await apiDeleteListing(id, adminPass);
      setList(prev => prev.filter(x => x.id !== id));
    } catch (e) {
      alert('Błąd usuwania: ' + e.message);
    }
  }

  return (
    <section className="w-full py-10">
      <div className="mx-auto max-w-7xl px-4">
        <h2 className="text-3xl font-semibold mb-4">Panel administratora</h2>

        <Card className="rounded-3xl bg-white/80 backdrop-blur mb-8">
          <CardHeader><CardTitle>Dodaj ogłoszenie</CardTitle></CardHeader>
          <CardContent>
            <form onSubmit={add} className="grid md:grid-cols-3 gap-3">
              <Input name="title" placeholder="Tytuł" required />
              <Input name="city" placeholder="Miasto" required />
              <Input name="district" placeholder="Dzielnica" />
              <Input name="street" placeholder="Ulica" />
              <Input name="type" placeholder="Typ (Mieszkanie/Dom/...)" />
              <Input name="price" type="number" placeholder="Cena" required />
              <Input name="area" type="number" placeholder="Metraż (m²)" required />
              <Input name="rooms" type="number" placeholder="Pokoje" required />
              <Input name="floor" type="number" placeholder="Piętro" />
              <label className="flex items-center gap-2"><input type="checkbox" name="balcony" /> Balkon</label>
              <label className="flex items-center gap-2"><input type="checkbox" name="terrace" /> Taras</label>
              <label className="flex items-center gap-2"><input type="checkbox" name="garden" /> Ogród</label>
              <div className="md:col-span-3">
                <textarea name="description" placeholder="Opis" className="w-full rounded-md border p-2 h-24"></textarea>
              </div>
              <div className="md:col-span-3">
                <label className="block text-sm text-zinc-600 mb-1">Zdjęcie (z dysku):</label>
                <input type="file" name="imageFile" accept="image/*" className="w-full" />
                <p className="text-xs text-zinc-500 mt-1">Możesz też zamiast pliku podać URL (opcjonalnie):</p>
                <Input name="imageUrl" placeholder="https://..." />
              </div>
              <div className="md:col-span-3">
                <Button type="submit" disabled={busy}>{busy ? 'Zapisywanie…' : 'Dodaj ogłoszenie'}</Button>
                {err && <div className="text-red-600 mt-2">{err}</div>}
              </div>
            </form>
          </CardContent>
        </Card>

        <h3 className="text-xl font-semibold mb-2">Twoje ogłoszenia</h3>
        <div className="grid md:grid-cols-3 gap-4">
          {list.map((x) => (
            <div key={x.id} className="rounded-2xl overflow-hidden border bg-white/70">
              <img src={x.image} alt={x.title} className="h-48 w-full object-cover" />
              <div className="p-4">
                <div className="font-semibold">{x.title}</div>
                <div className="text-sm text-zinc-500">{x.city}{x.district?` • ${x.district}`:''} • {x.street}</div>
                <div className="text-sm text-zinc-500">{x.area} m² • {x.rooms} pokoje • piętro {x.floor || '-'}</div>
                <div className="text-lg font-semibold mt-1">{currency(x.price)}</div>
                <Button variant="destructive" className="mt-3" onClick={() => remove(x.id)}><Icon name="Trash" className="mr-2" />Usuń</Button>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
}

// ---------- FOOTER ----------
function Footer() {
  return (
    <footer className="py-10 border-t bg-white/60 backdrop-blur">
      <div className="mx-auto max-w-7xl px-4 flex flex-col items-center text-center gap-4 text-sm text-zinc-600">
        <div className="flex items-center gap-3">
          <img src="https://i.imgur.com/UwnwhuV.png" alt="Logo" className="h-10 w-10" />
          <div>
            <div className="font-semibold tracking-tight">© {new Date().getFullYear()} Centrum nieruchomości</div>
            <div className="text-xs text-zinc-600">Zacharska Klaudia</div>
          </div>
        </div>
      </div>
    </footer>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>

</body>

</html>

